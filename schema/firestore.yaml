# Firestore Schema Definition (Slack-style Stream)
# Both server (Go) and client (SwiftUI) should reference this schema.
# Document IDs for both threads and messages should use UUID v7 for time-ordering.

collections:
  threads:
    description: "Main timeline posts (like Slack messages in a channel)"
    fields:
      - name: userId
        type: string
        description: "Owner of the thread"

      - name: firstMessage
        type: string
        description: "The first message content. Acts as the thread's identity."

      - name: unreadCount
        type: number
        description: "Number of unread messages"

      - name: lastReadAt
        type: timestamp
        description: "Timestamp of the last read message"

      - name: replyCount
        type: number
        description: "Total number of replies in messages subcollection"

      - name: isPrivate
        type: boolean
        description: "If true, excluded from weekly reports"

      - name: isArchived
        type: boolean
        description: "If true, hidden from thread list"

      - name: sessionMemory
        type: string # JSON string
        description: "JSON string containing structured summary, decisions, and entities"

      - name: memorizedUntil
        type: timestamp
        description: "The createdAt of the last message included in the sessionMemory"

      - name: createdAt
        type: timestamp
        description: "Original post timestamp (UUID v7 should also encode this)"

    subcollections:
      messages:
        description: "Messages in a thread"
        fields:
          - name: role
            type: string
            description: "Message sender role"
            enum:
              - user
              - assistant

          - name: content
            type: string
            description: "Reply message content (supports markdown)"

          - name: attachments
            type: array
            description: "Attached files in the reply"
            items:
              type: map
              fields:
                - name: type
                  type: string
                  enum: [image, text, document, audio, video]
                - name: url
                  type: string
                - name: mimeType
                  type: string
                - name: name
                  type: string
                - name: size
                  type: number

          - name: aiMetadata
            type: map
            description: "AI response metadata"
            fields:
              - name: model
                type: string
              - name: usage
                type: map
                fields:
                  - name: promptTokens
                    type: number
                  - name: completionTokens
                    type: number
                  - name: totalTokens
                    type: number
              - name: finishReason
                type: string
              - name: responseId
                type: string

          - name: createdAt
            type: timestamp
